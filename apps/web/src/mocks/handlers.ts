import { http, HttpResponse } from "msw";

import type { OptionsApiResponse, OptionComboLegApi, StocksApiResponse } from "../lib/types";

const minutesAgo = (anchor: Date, minutes: number) =>
  new Date(anchor.getTime() - minutes * 60_000).toISOString();

export const buildStocksResponse = (
  overrides: Partial<StocksApiResponse> = {},
): StocksApiResponse => {
  const now = new Date();
  const minutesAgoFromNow = (minutes: number) => minutesAgo(now, minutes);
  const base: StocksApiResponse = {
    as_of: now.toISOString(),
    data: [
      {
        symbol: "AAPL",
        quantity: 120,
        average_price: 173.52,
        mark_price: 176.18,
        mark_source: "MID",
        mark_time: minutesAgoFromNow(1),
        day_pnl_amount: 412.35,
        day_pnl_percent: 2.38,
        total_pnl_amount: 1185.67,
        total_pnl_percent: 6.85,
        currency: "USD",
      },
      {
        symbol: "MSFT",
        quantity: 96,
        average_price: 292.4,
        mark_price: 288.95,
        mark_source: "LAST",
        mark_time: minutesAgoFromNow(7),
        day_pnl_amount: -128.12,
        day_pnl_percent: -0.86,
        total_pnl_amount: 642.31,
        total_pnl_percent: 2.27,
        currency: "USD",
      },
      {
        symbol: "NVDA",
        quantity: 54,
        average_price: 446.75,
        mark_price: 452.21,
        mark_source: "PREV",
        mark_time: minutesAgoFromNow(16),
        day_pnl_amount: 238.91,
        day_pnl_percent: 1.42,
        total_pnl_amount: 1835.44,
        total_pnl_percent: 7.14,
        currency: "USD",
        exposure: 24419.34,
      },
    ],
  };

  return {
    as_of: overrides.as_of ?? base.as_of,
    data: overrides.data ?? base.data,
  };
};

export const buildOptionsResponse = (
  overrides: Partial<OptionsApiResponse> = {},
): OptionsApiResponse => {
  const now = new Date();
  const minutesAgoFromNow = (minutes: number) => minutesAgo(now, minutes);

  const baseLegs: OptionComboLegApi[] = [
    {
      id: "leg-condor-short-call",
      combo_id: "combo-iron-condor",
      underlying: "SPX",
      expiry: "2024-10-18",
      strike: 4600,
      right: "C",
      quantity: -10,
      mark_price: 1.05,
      mark_source: "MID",
      mark_time: minutesAgoFromNow(2),
      delta: 0.12,
      gamma: 0.01,
      theta: -4.2,
      vega: -18.5,
      iv: 0.19,
      day_pnl_amount: 480,
      day_pnl_percent: 12.4,
      total_pnl_amount: 1240,
      total_pnl_percent: 18.1,
    },
    {
      id: "leg-condor-long-call",
      combo_id: "combo-iron-condor",
      underlying: "SPX",
      expiry: "2024-10-18",
      strike: 4650,
      right: "C",
      quantity: 10,
      mark_price: 0.52,
      mark_source: "MID",
      mark_time: minutesAgoFromNow(2),
      delta: -0.04,
      gamma: -0.01,
      theta: 1.6,
      vega: 9.3,
      iv: 0.19,
      day_pnl_amount: -140,
      day_pnl_percent: -8.4,
      total_pnl_amount: -260,
      total_pnl_percent: -11.3,
    },
    {
      id: "leg-condor-short-put",
      combo_id: "combo-iron-condor",
      underlying: "SPX",
      expiry: "2024-10-18",
      strike: 4300,
      right: "P",
      quantity: -10,
      mark_price: 1.12,
      mark_source: "MID",
      mark_time: minutesAgoFromNow(3),
      delta: -0.18,
      gamma: 0.0,
      theta: -4.7,
      vega: -21.2,
      iv: 0.21,
      day_pnl_amount: 520,
      day_pnl_percent: 14.2,
      total_pnl_amount: 1420,
      total_pnl_percent: 21.6,
    },
    {
      id: "leg-condor-long-put",
      combo_id: "combo-iron-condor",
      underlying: "SPX",
      expiry: "2024-10-18",
      strike: 4250,
      right: "P",
      quantity: 10,
      mark_price: 0.46,
      mark_source: "MID",
      mark_time: minutesAgoFromNow(3),
      delta: 0.06,
      gamma: -0.0,
      theta: 1.9,
      vega: 10.1,
      iv: 0.21,
      day_pnl_amount: -160,
      day_pnl_percent: -9.8,
      total_pnl_amount: -330,
      total_pnl_percent: -12.1,
    },
    {
      id: "leg-diagonal-long-call",
      combo_id: "combo-call-diagonal",
      underlying: "AAPL",
      expiry: "2024-11-15",
      strike: 195,
      right: "C",
      quantity: 5,
      mark_price: 7.65,
      mark_source: "LAST",
      mark_time: minutesAgoFromNow(6),
      delta: 0.38,
      gamma: 0.04,
      theta: -3.4,
      vega: 28.5,
      iv: 0.32,
      day_pnl_amount: 280,
      day_pnl_percent: 3.8,
      total_pnl_amount: 1040,
      total_pnl_percent: 12.6,
    },
    {
      id: "leg-diagonal-short-call",
      combo_id: "combo-call-diagonal",
      underlying: "AAPL",
      expiry: "2024-09-20",
      strike: 190,
      right: "C",
      quantity: -5,
      mark_price: 3.25,
      mark_source: "LAST",
      mark_time: minutesAgoFromNow(4),
      delta: -0.28,
      gamma: -0.03,
      theta: 4.1,
      vega: -22.1,
      iv: 0.29,
      day_pnl_amount: -90,
      day_pnl_percent: -2.7,
      total_pnl_amount: -260,
      total_pnl_percent: -6.3,
    },
    {
      id: "leg-orphan-put",
      combo_id: null,
      underlying: "TSLA",
      expiry: "2024-09-06",
      strike: 210,
      right: "P",
      quantity: 3,
      mark_price: 4.9,
      mark_source: "PREV",
      mark_time: minutesAgoFromNow(18),
      delta: -0.32,
      gamma: 0.02,
      theta: -2.1,
      vega: 14.3,
      iv: 0.41,
      day_pnl_amount: -35,
      day_pnl_percent: -1.9,
      total_pnl_amount: -128,
      total_pnl_percent: -8.2,
    },
    {
      id: "leg-orphan-call",
      combo_id: null,
      underlying: "MSFT",
      expiry: "2024-12-20",
      strike: 360,
      right: "C",
      quantity: -2,
      mark_price: 6.1,
      mark_source: "MID",
      mark_time: minutesAgoFromNow(12),
      delta: -0.18,
      gamma: 0.01,
      theta: 1.2,
      vega: -9.8,
      iv: 0.27,
      day_pnl_amount: 75,
      day_pnl_percent: 1.6,
      total_pnl_amount: 210,
      total_pnl_percent: 5.1,
    },
  ];

  const baseCombos = [
    {
      id: "combo-iron-condor",
      strategy: "Iron Condor",
      underlying: "SPX",
      expiry: "2024-10-18",
      dte: 32,
      side: "credit" as const,
      net_premium: 2.21,
      mark_price: 1.98,
      mark_source: "MID" as const,
      mark_time: minutesAgoFromNow(2),
      greeks: {
        delta: -0.04,
        gamma: 0.01,
        theta: -5.4,
        vega: -20.3,
      },
      day_pnl_amount: 700,
      day_pnl_percent: 11.2,
      total_pnl_amount: 1850,
      total_pnl_percent: 24.8,
    },
    {
      id: "combo-call-diagonal",
      strategy: "Call Diagonal",
      underlying: "AAPL",
      expiry: "2024-11-15",
      dte: 60,
      side: "debit" as const,
      net_premium: -4.4,
      mark_price: 4.62,
      mark_source: "LAST" as const,
      mark_time: minutesAgoFromNow(5),
      greeks: {
        delta: 0.14,
        gamma: 0.02,
        theta: 0.7,
        vega: 6.4,
      },
      day_pnl_amount: 190,
      day_pnl_percent: 3.1,
      total_pnl_amount: 780,
      total_pnl_percent: 9.5,
    },
  ].map((combo) => ({
    ...combo,
    legs: baseLegs.filter((leg) => leg.combo_id === combo.id),
  }));

  const base: OptionsApiResponse = {
    as_of: now.toISOString(),
    combos: baseCombos,
    legs: baseLegs,
  };

  return {
    as_of: overrides.as_of ?? base.as_of,
    combos: overrides.combos ?? base.combos,
    legs: overrides.legs ?? base.legs,
  };
};

export const handlers = [
  http.get("*/positions/stocks", () => HttpResponse.json(buildStocksResponse())),
  http.get("*/positions/options", () => HttpResponse.json(buildOptionsResponse())),
];
